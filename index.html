<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://www.gstatic.com https://apis.google.com; object-src 'none';">
  <title>Google Sheets API Redirect Test</title>
</head>
<body>
  <h1>Google Sheets API Redirect Test</h1>
  <button id="signInRedirectBtn">Sign In with Redirect</button>
  <button id="appendDataBtn">Append Data to Sheet</button>
  <pre id="output" style="background: #f0f0f0; padding: 1em;"></pre>

  <!-- Load the Google API client library -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    // Replace with your own credentials
    const CLIENT_ID = '110744525010-34st0v7r172u2uerpi2e3j1ghkk555qk.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBfkl02IsZznHMlkNhyqzDQr4TfUJc6-Bw';
    const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';
    const SPREADSHEET_ID = '1Mj5WJU8NhcAjbvGbia3S8Uo74ng_zKo8mJSE3ANy7lM';
    // Must be registered as an Authorized Redirect URI in your Cloud Console.
    const REDIRECT_URI = 'https://s2admincan.github.io/SESSIONS/logsession.html';

    // Initialize the client after gapi is loaded.
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        scope: SCOPE,
        // Including the Sheets API discovery document ensures gapi.client.sheets is available.
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      }).then(() => {
        logOutput('GAPI client initialized. Ready for API calls.');
      }).catch((error) => {
        logOutput('Error initializing GAPI client:\n' + JSON.stringify(error, null, 2));
      });
    }

    // Load gapi client and auth2, then initialize client.
    gapi.load('client:auth2', initClient);

    // Redirect-based sign in function.
    function redirectSignIn() {
      const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';
      const params = {
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'token', // Implicit flow returns an access token in the URL hash.
        scope: SCOPE,
        include_granted_scopes: 'true',
        state: 'pass-through value'
      };

      // Construct the URL for the OAuth 2.0 request.
      const url = oauth2Endpoint + '?' +
        Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');

      // Redirect the browser to the OAuth 2.0 endpoint.
      window.location.href = url;
    }

    // Append a row of data to the Google Sheet.
    function appendData() {
      // Ensure that gapi.client.sheets is defined.
      if (!gapi.client.sheets) {
        logOutput("Error: gapi.client.sheets is undefined. Ensure the Sheets API discovery document is loaded.");
        return;
      }

      // Example data to append.
      const values = [
        ["Test Data", new Date().toString()]
      ];
      const body = { values };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'Sheet1!A2', // Adjust range as needed.
        valueInputOption: 'RAW',
        resource: body
      }).then((response) => {
        logOutput("Data appended successfully:\n" + JSON.stringify(response.result, null, 2));
      }).catch((error) => {
        logOutput("Error appending data:\n" + JSON.stringify(error, null, 2));
      });
    }

    // Helper function to log output to the <pre> element.
    function logOutput(message) {
      const output = document.getElementById('output');
      output.textContent = message;
      console.log(message);
    }

    // Attach event listeners to buttons.
    document.getElementById('signInRedirectBtn').addEventListener('click', redirectSignIn);
    document.getElementById('appendDataBtn').addEventListener('click', appendData);

    // On page load, if redirected back from sign in, display the token (optional).
    window.onload = function() {
      // If there's an access token in the URL hash, you can parse it here.
      if (window.location.hash) {
        const hash = window.location.hash.substring(1); // Remove the '#'
        const params = new URLSearchParams(hash);
        if (params.has('access_token')) {
          const token = params.get('access_token');
          logOutput("Access token received:\n" + token);
          // Optionally, remove the hash for a cleaner URL:
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    }
  </script>
</body>
</html>
